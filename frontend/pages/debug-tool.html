<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tool - Fashion Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .debug-card {
            background: #f8f9fa;
            border-left: 4px solid #0d6efd;
            margin-bottom: 1rem;
        }
        .log-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-tools me-2"></i>
                Fashion Shop - Debug Tool
            </span>
            <a href="../index.html" class="btn btn-outline-light btn-sm">
                <i class="fas fa-home me-1"></i> V·ªÅ trang ch·ªß
            </a>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Debug Tool</strong> - C√¥ng c·ª• ki·ªÉm tra v√† kh·∫Øc ph·ª•c l·ªói gi·ªè h√†ng
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column - Actions -->
            <div class="col-md-6">
                <div class="card debug-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Th√¥ng tin h·ªá th·ªëng
                        </h5>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">API Base URL:</label>
                            <input type="text" class="form-control form-control-sm" id="apiUrl" value="http://localhost:5000/api">
                        </div>
                        <button class="btn btn-sm btn-primary w-100" onclick="checkSystemInfo()">
                            <i class="fas fa-check-circle me-1"></i> Ki·ªÉm tra h·ªá th·ªëng
                        </button>
                    </div>
                </div>

                <div class="card debug-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-shopping-cart text-success me-2"></i>
                            Ki·ªÉm tra gi·ªè h√†ng
                        </h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="checkCart()">
                                <i class="fas fa-search me-1"></i> Xem th√¥ng tin gi·ªè h√†ng
                            </button>
                            <button class="btn btn-info" onclick="countCartItems()">
                                <i class="fas fa-calculator me-1"></i> ƒê·∫øm s·ªë l∆∞·ª£ng items
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card debug-card border-danger">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            Kh·∫Øc ph·ª•c l·ªói
                        </h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning" onclick="clearCart()">
                                <i class="fas fa-trash me-1"></i> X√≥a to√†n b·ªô gi·ªè h√†ng (API)
                            </button>
                            <button class="btn btn-secondary" onclick="clearLocalStorage()">
                                <i class="fas fa-broom me-1"></i> X√≥a localStorage
                            </button>
                            <button class="btn btn-danger" onclick="emergencyReset()">
                                <i class="fas fa-redo me-1"></i> Reset to√†n b·ªô (Emergency)
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            ‚ö†Ô∏è C√°c thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!
                        </small>
                    </div>
                </div>

                <div class="card debug-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-tools text-info me-2"></i>
                            C√¥ng c·ª• kh√°c
                        </h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="testAPIConnection()">
                                <i class="fas fa-plug me-1"></i> Test k·∫øt n·ªëi API
                            </button>
                            <button class="btn btn-outline-success" onclick="viewToken()">
                                <i class="fas fa-key me-1"></i> Xem Token
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearLogs()">
                                <i class="fas fa-eraser me-1"></i> X√≥a logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Logs -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-terminal me-2"></i>
                            Console Logs
                        </span>
                        <button class="btn btn-sm btn-outline-light" onclick="clearLogs()">
                            Clear
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-output" id="logOutput">
                            <div class="info">> Debug Tool Ready</div>
                            <div class="text-muted">Nh·∫•n c√°c n√∫t b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu...</div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            H∆∞·ªõng d·∫´n nhanh
                        </h6>
                        <ol class="small mb-0">
                            <li>Ki·ªÉm tra h·ªá th·ªëng tr∆∞·ªõc</li>
                            <li>Xem th√¥ng tin gi·ªè h√†ng</li>
                            <li>N·∫øu c√≥ l·ªói, th·ª≠ "X√≥a to√†n b·ªô gi·ªè h√†ng"</li>
                            <li>N·∫øu v·∫´n l·ªói, d√πng "Emergency Reset"</li>
                            <li>Reload trang sau khi reset</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = document.getElementById('apiUrl').value;

        function log(message, type = 'info') {
            const output = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const icon = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            }[type] || '‚ÑπÔ∏è';
            
            output.innerHTML += `<div class="${className}">[${timestamp}] ${icon} ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '<div class="info">> Logs cleared</div>';
        }

        function getToken() {
            return localStorage.getItem('token');
        }

        async function checkSystemInfo() {
            log('ƒêang ki·ªÉm tra h·ªá th·ªëng...', 'info');
            
            const token = getToken();
            const apiUrl = document.getElementById('apiUrl').value;
            
            log(`API URL: ${apiUrl}`, 'info');
            log(`Token: ${token ? 'C√≥ ‚úì' : 'Kh√¥ng c√≥ ‚úó'}`, token ? 'success' : 'error');
            
            if (token) {
                try {
                    const decoded = JSON.parse(atob(token.split('.')[1]));
                    const exp = new Date(decoded.exp * 1000);
                    const now = new Date();
                    const isExpired = exp < now;
                    
                    log(`Token h·∫øt h·∫°n: ${isExpired ? 'C√≥ ‚úó' : 'Kh√¥ng ‚úì'}`, isExpired ? 'error' : 'success');
                    log(`H·∫øt h·∫°n l√∫c: ${exp.toLocaleString()}`, 'info');
                } catch (e) {
                    log(`L·ªói decode token: ${e.message}`, 'error');
                }
            }
            
            log('‚úì Ki·ªÉm tra xong!', 'success');
        }

        async function checkCart() {
            log('ƒêang l·∫•y th√¥ng tin gi·ªè h√†ng...', 'info');
            
            const token = getToken();
            if (!token) {
                log('Ch∆∞a ƒëƒÉng nh·∫≠p!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    log(`S·ªë items: ${data.data.items.length}`, 'success');
                    log(`Chi ti·∫øt:`, 'info');
                    log(JSON.stringify(data.data, null, 2), 'info');
                } else {
                    log(`L·ªói: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        async function countCartItems() {
            log('ƒêang ƒë·∫øm items...', 'info');
            
            const token = getToken();
            if (!token) {
                log('Ch∆∞a ƒëƒÉng nh·∫≠p!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    const count = data.data.items.length;
                    log(`T·ªïng s·ªë items: ${count}`, count > 50 ? 'error' : count > 20 ? 'warning' : 'success');
                    
                    if (count > 50) {
                        log('‚ö†Ô∏è Qu√° nhi·ªÅu items! N√™n x√≥a b·ªõt.', 'error');
                    } else if (count > 20) {
                        log('‚ö†Ô∏è Nhi·ªÅu items, c√≥ th·ªÉ g√¢y lag.', 'warning');
                    } else {
                        log('‚úì S·ªë l∆∞·ª£ng items OK', 'success');
                    }
                } else {
                    log(`L·ªói: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`L·ªói: ${error.message}`, 'error');
            }
        }

        async function clearCart() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA TO√ÄN B·ªò gi·ªè h√†ng?')) {
                log('ƒê√£ h·ªßy thao t√°c', 'info');
                return;
            }

            log('ƒêang x√≥a gi·ªè h√†ng...', 'warning');
            
            const token = getToken();
            if (!token) {
                log('Ch∆∞a ƒëƒÉng nh·∫≠p!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/cart/clear`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ ƒê√£ x√≥a gi·ªè h√†ng th√†nh c√¥ng!', 'success');
                    log('Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t...', 'info');
                } else {
                    log(`L·ªói: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`L·ªói: ${error.message}`, 'error');
            }
        }

        function clearLocalStorage() {
            if (!confirm('X√≥a t·∫•t c·∫£ d·ªØ li·ªáu localStorage?\n(Token, user, cart...)')) {
                log('ƒê√£ h·ªßy', 'info');
                return;
            }

            log('ƒêang x√≥a localStorage...', 'warning');
            
            const keys = ['token', 'user', 'cart'];
            keys.forEach(key => {
                localStorage.removeItem(key);
                log(`ƒê√£ x√≥a: ${key}`, 'success');
            });
            
            log('‚úì Ho√†n t·∫•t!', 'success');
            log('Reload trang ƒë·ªÉ ƒëƒÉng nh·∫≠p l·∫°i', 'info');
        }

        async function emergencyReset() {
            if (!confirm('‚ö†Ô∏è EMERGENCY RESET!\n\nX√≥a gi·ªè h√†ng + localStorage + Session.\nB·∫°n c√≥ ch·∫Øc?')) {
                log('ƒê√£ h·ªßy', 'info');
                return;
            }

            log('üö® B·∫ÆT ƒê·∫¶U EMERGENCY RESET...', 'error');
            
            // 1. Clear API cart
            try {
                const token = getToken();
                if (token) {
                    await fetch(`${API_BASE_URL}/cart/clear`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    log('‚úì ƒê√£ x√≥a gi·ªè h√†ng API', 'success');
                }
            } catch (e) {
                log(`L·ªói x√≥a cart API: ${e.message}`, 'warning');
            }

            // 2. Clear localStorage
            localStorage.clear();
            log('‚úì ƒê√£ x√≥a localStorage', 'success');

            // 3. Clear sessionStorage
            sessionStorage.clear();
            log('‚úì ƒê√£ x√≥a sessionStorage', 'success');

            log('‚úÖ EMERGENCY RESET HO√ÄN T·∫§T!', 'success');
            log('Reload trong 3 gi√¢y...', 'info');
            
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 3000);
        }

        async function testAPIConnection() {
            log('ƒêang test k·∫øt n·ªëi API...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/products?limit=1`);
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ API ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng', 'success');
                } else {
                    log('‚ö†Ô∏è API c√≥ v·∫•n ƒë·ªÅ', 'warning');
                }
            } catch (error) {
                log(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi: ${error.message}`, 'error');
                log('Ki·ªÉm tra xem backend c√≥ ƒëang ch·∫°y kh√¥ng?', 'warning');
            }
        }

        function viewToken() {
            const token = getToken();
            if (!token) {
                log('Kh√¥ng c√≥ token', 'warning');
                return;
            }

            log('Token:', 'info');
            log(token, 'info');
            
            try {
                const decoded = JSON.parse(atob(token.split('.')[1]));
                log('Decoded:', 'info');
                log(JSON.stringify(decoded, null, 2), 'info');
            } catch (e) {
                log(`L·ªói decode: ${e.message}`, 'error');
            }
        }
    </script>
</body>
</html>