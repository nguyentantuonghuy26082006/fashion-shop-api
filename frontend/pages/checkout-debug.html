<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n (Debug) - Fashion Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            max-height: 300px;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            border-top-left-radius: 10px;
            box-shadow: -5px -5px 20px rgba(0,0,0,0.3);
        }
        .debug-panel .log {
            margin: 2px 0;
            padding: 2px 5px;
            border-left: 3px solid;
        }
        .debug-panel .log.error {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        .debug-panel .log.success {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }
        .debug-panel .log.info {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
        }
        .debug-panel .log.warning {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }
        .debug-header {
            background: #333;
            margin: -10px -10px 10px -10px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .debug-header button {
            background: #f44336;
            border: none;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-header">
            <strong>üêõ DEBUG LOGS</strong>
            <button onclick="clearDebugLogs()">Clear</button>
        </div>
        <div id="debugLogs"></div>
    </div>

    <!-- Navbar (Simple) -->
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="../index.html">
                <i class="fas fa-shopping-bag text-primary"></i>
                <span class="ms-2 gradient-text">FASHION SHOP</span>
                <span class="badge bg-danger ms-2">DEBUG MODE</span>
            </a>
            <div class="text-muted">
                <i class="fas fa-lock me-1"></i>
                Thanh to√°n an to√†n
            </div>
        </div>
    </nav>

    <!-- Checkout Steps -->
    <section class="py-3 bg-light">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="d-flex justify-content-between">
                        <div class="text-center">
                            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px;">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <p class="small mt-1 mb-0">Gi·ªè h√†ng</p>
                        </div>
                        <div class="text-center">
                            <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px;">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <p class="small mt-1 mb-0 fw-bold">Thanh to√°n</p>
                        </div>
                        <div class="text-center">
                            <div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px;">
                                <i class="fas fa-check"></i>
                            </div>
                            <p class="small mt-1 mb-0 text-muted">Ho√†n t·∫•t</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Checkout Form -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <!-- Shipping Info Form -->
                <div class="col-lg-7">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-4">
                                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                Th√¥ng tin giao h√†ng
                            </h5>

                            <form id="checkoutForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">H·ªç t√™n <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="fullName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span
                                                class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="phone" pattern="[0-9]{10,11}"
                                            required>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="street"
                                        placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..." required>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">T·ªânh/Th√†nh ph·ªë <span
                                                class="text-danger">*</span></label>
                                        <select class="form-select" id="city" required>
                                            <option value="">Ch·ªçn...</option>
                                            <option value="H·ªì Ch√≠ Minh">TP. H·ªì Ch√≠ Minh</option>
                                            <option value="H√† N·ªôi">H√† N·ªôi</option>
                                            <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                                            <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                                            <option value="Kh√°c">Kh√°c...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Qu·∫≠n/Huy·ªán</label>
                                        <input type="text" class="form-control" id="district">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Ph∆∞·ªùng/X√£</label>
                                        <input type="text" class="form-control" id="ward">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Ghi ch√∫ (t√πy ch·ªçn)</label>
                                    <textarea class="form-control" id="note" rows="3"
                                        placeholder="Ghi ch√∫ th√™m v·ªÅ ƒë∆°n h√†ng..."></textarea>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-4">
                                <i class="fas fa-credit-card text-primary me-2"></i>
                                Ph∆∞∆°ng th·ª©c thanh to√°n
                            </h5>

                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod"
                                    checked>
                                <label class="form-check-label w-100" for="cod">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-money-bill-wave fa-2x text-success me-3"></i>
                                        <div>
                                            <strong>Thanh to√°n khi nh·∫≠n h√†ng (COD)</strong>
                                            <p class="text-muted small mb-0">
                                                Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng
                                            </p>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <div class="form-check mb-3 p-3 border rounded">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="bank_transfer"
                                    value="bank_transfer">
                                <label class="form-check-label w-100" for="bank_transfer">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-university fa-2x text-primary me-3"></i>
                                        <div>
                                            <strong>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong>
                                            <p class="text-muted small mb-0">Chuy·ªÉn kho·∫£n qua ng√¢n h√†ng</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="col-lg-5">
                    <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-4">
                                <i class="fas fa-receipt text-primary me-2"></i>
                                ƒê∆°n h√†ng c·ªßa b·∫°n
                            </h5>

                            <div id="orderItems" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                    <p class="small text-muted mt-2">ƒêang t·∫£i...</p>
                                </div>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between mb-2">
                                <span>T·∫°m t√≠nh:</span>
                                <span id="subtotal" class="fw-bold">0 ‚Ç´</span>
                            </div>

                            <div class="d-flex justify-content-between mb-2">
                                <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <span id="shippingFee" class="fw-bold">30,000 ‚Ç´</span>
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between mb-4">
                                <span class="fw-bold fs-5">T·ªïng c·ªông:</span>
                                <span id="totalAmount" class="fw-bold fs-4 text-primary">0 ‚Ç´</span>
                            </div>

                            <button class="btn btn-primary w-100 py-3 rounded-pill mb-3" onclick="placeOrder()" id="placeOrderBtn">
                                <i class="fas fa-check-circle me-2"></i>
                                ƒê·∫∑t h√†ng
                            </button>

                            <a href="cart.html" class="btn btn-outline-secondary w-100 rounded-pill">
                                <i class="fas fa-arrow-left me-2"></i>
                                Quay l·∫°i gi·ªè h√†ng
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>

    <script>
        let cart = null;
        const SHIPPING_FEE = 30000;

        // Debug logging function
        function debugLog(message, type = 'info') {
            const logsContainer = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            const log = document.createElement('div');
            log.className = `log ${type}`;
            
            const icon = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            }[type] || '‚ÑπÔ∏è';
            
            log.innerHTML = `<small>[${timestamp}] ${icon} ${message}</small>`;
            logsContainer.appendChild(log);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // Also log to console
            console.log(`[${timestamp}] ${icon} ${message}`);
        }

        function clearDebugLogs() {
            document.getElementById('debugLogs').innerHTML = '';
            debugLog('Logs cleared', 'info');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            debugLog('üöÄ Page loaded', 'info');
            
            if (!requireAuth()) {
                debugLog('‚ùå User not authenticated', 'error');
                return;
            }

            debugLog('‚úÖ User authenticated', 'success');

            // Load user info
            try {
                debugLog('üìù Loading user profile...', 'info');
                const userData = await getProfile();
                if (userData.success) {
                    const user = userData.data;
                    debugLog(`‚úÖ Profile loaded: ${user.fullName}`, 'success');
                    
                    document.getElementById('fullName').value = user.fullName || '';
                    document.getElementById('phone').value = user.phone || '';
                    document.getElementById('email').value = user.email || '';

                    if (user.address) {
                        document.getElementById('street').value = user.address.street || '';
                        document.getElementById('city').value = user.address.city || '';
                        document.getElementById('district').value = user.address.district || '';
                        document.getElementById('ward').value = user.address.ward || '';
                    }
                }
            } catch (error) {
                debugLog(`‚ö†Ô∏è Profile load error: ${error.message}`, 'warning');
            }

            // Load cart
            await loadCart();
        });

        async function loadCart() {
            try {
                debugLog('üõí Loading cart...', 'info');
                
                const data = await getCart();
                debugLog(`üì¶ Cart data received: ${JSON.stringify(data)}`, 'info');

                if (data.success) {
                    cart = data.data;
                    debugLog(`‚úÖ Cart loaded: ${cart.items.length} items`, 'success');
                    displayOrderSummary();
                } else {
                    debugLog(`‚ùå Cart load failed: ${data.message}`, 'error');
                    showToast('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!', 'error');
                    setTimeout(() => window.location.href = 'cart.html', 1500);
                }
            } catch (error) {
                debugLog(`‚ùå Cart load error: ${error.message}`, 'error');
                console.error('Error:', error);
                showToast('C√≥ l·ªói x·∫£y ra!', 'error');
            }
        }

        function displayOrderSummary() {
            debugLog('üé® Rendering order summary...', 'info');
            
            const container = document.getElementById('orderItems');

            if (!cart.items || cart.items.length === 0) {
                debugLog('‚ö†Ô∏è Cart is empty', 'warning');
                showToast('Gi·ªè h√†ng tr·ªëng!', 'error');
                setTimeout(() => window.location.href = 'cart.html', 1500);
                return;
            }

            container.innerHTML = cart.items.map(item => `
                <div class="d-flex align-items-center mb-3">
                    <img src="${item.product?.images?.[0]?.url || 'https://via.placeholder.com/60'}" 
                         alt="${item.product?.name || 'Product'}" 
                         class="rounded me-3" 
                         style="width: 60px; height: 60px; object-fit: cover;">
                    <div class="flex-grow-1">
                        <h6 class="mb-0 small">${item.product?.name || 'S·∫£n ph·∫©m'}</h6>
                        <small class="text-muted">
                            SL: ${item.quantity}
                            ${item.size ? ` | Size: ${item.size}` : ''}
                            ${item.color ? ` | M√†u: ${item.color}` : ''}
                        </small>
                    </div>
                    <strong class="small">${formatPrice((item.price || 0) * item.quantity)}</strong>
                </div>
            `).join('');

            const subtotal = cart.items.reduce((sum, item) => sum + ((item.price || 0) * item.quantity), 0);
            const shippingFee = subtotal > 500000 ? 0 : SHIPPING_FEE;
            const total = subtotal + shippingFee;

            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('shippingFee').textContent = shippingFee === 0 ? 'Mi·ªÖn ph√≠' : formatPrice(shippingFee);
            document.getElementById('totalAmount').textContent = formatPrice(total);
            
            debugLog(`‚úÖ Summary rendered: ${cart.items.length} items, total: ${total}`, 'success');
        }

        async function placeOrder() {
            debugLog('üéØ ===== PLACE ORDER STARTED =====', 'warning');
            
            // Validate form
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                debugLog('‚ùå Form validation failed', 'error');
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                return;
            }
            debugLog('‚úÖ Form validation passed', 'success');

            // Validate cart
            if (!cart || !cart.items || cart.items.length === 0) {
                debugLog('‚ùå Cart is empty or invalid', 'error');
                showToast('Gi·ªè h√†ng tr·ªëng!', 'error');
                return;
            }
            debugLog(`‚úÖ Cart validated: ${cart.items.length} items`, 'success');

            // Disable button
            const orderBtn = document.getElementById('placeOrderBtn');
            orderBtn.disabled = true;
            orderBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang x·ª≠ l√Ω...';

            // Prepare order data
            const orderData = {
                items: cart.items.map(item => ({
                    productId: item.product?._id,
                    quantity: item.quantity,
                    size: item.size || '',
                    color: item.color || ''
                })).filter(item => item.productId),
                shippingAddress: {
                    fullName: document.getElementById('fullName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    street: document.getElementById('street').value.trim(),
                    city: document.getElementById('city').value,
                    district: document.getElementById('district').value.trim(),
                    ward: document.getElementById('ward').value.trim(),
                    note: document.getElementById('note').value.trim()
                },
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value
            };

            debugLog('üìù Order data prepared:', 'info');
            debugLog(JSON.stringify(orderData, null, 2), 'info');

            try {
                showLoading();
                debugLog('üì§ Sending order request...', 'info');
                debugLog(`API URL: ${API_BASE_URL}/orders`, 'info');
                debugLog(`Token: ${getToken() ? 'Present' : 'Missing'}`, getToken() ? 'success' : 'error');
                
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(orderData)
                });

                debugLog(`üì• Response status: ${response.status} ${response.statusText}`, 'info');
                
                const data = await response.json();
                debugLog('üì¶ Response data:', 'info');
                debugLog(JSON.stringify(data, null, 2), 'info');
                
                hideLoading();

                if (data.success) {
                    debugLog('‚úÖ Order placed successfully!', 'success');
                    debugLog(`Order ID: ${data.data._id}`, 'success');
                    showToast('ƒê·∫∑t h√†ng th√†nh c√¥ng!');
                    setTimeout(() => {
                        window.location.href = `orders.html`;
                    }, 1500);
                } else {
                    debugLog(`‚ùå Order failed: ${data.message}`, 'error');
                    showToast(data.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i!', 'error');
                    orderBtn.disabled = false;
                    orderBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>ƒê·∫∑t h√†ng';
                }
            } catch (error) {
                hideLoading();
                debugLog(`‚ùå EXCEPTION: ${error.message}`, 'error');
                debugLog(`Stack: ${error.stack}`, 'error');
                
                showToast('C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng!', 'error');
                
                orderBtn.disabled = false;
                orderBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>ƒê·∫∑t h√†ng';
            }
            
            debugLog('üéØ ===== PLACE ORDER ENDED =====', 'warning');
        }
    </script>
</body>

</html>