<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đơn hàng - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- html2pdf library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { font-family: 'Poppins', sans-serif; }
        
        /* Invoice Styles for PDF */
        .invoice-container {
            background: white;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .invoice-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .invoice-logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .invoice-title {
            font-size: 28px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .invoice-info-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .invoice-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            padding: 12px;
        }

        .invoice-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .invoice-total-row {
            background: #f8f9fa;
            font-weight: bold;
        }

        .invoice-grand-total {
            background: #667eea !important;
            color: white !important;
            font-size: 18px;
        }

        .invoice-footer {
            border-top: 2px solid #eee;
            padding-top: 20px;
            margin-top: 30px;
            text-align: center;
            color: #666;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        @media print {
            .print-hide { display: none !important; }
            .modal-dialog { max-width: 100% !important; margin: 0 !important; }
            .modal-content { border: none !important; box-shadow: none !important; }
        }
    </style>
</head>

<body>
    <!-- Admin Navbar -->
    <nav class="navbar navbar-dark bg-dark shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="fas fa-shield-alt text-primary"></i>
                <span class="ms-2">ADMIN PANEL</span>
            </a>
            <div class="d-flex align-items-center">
                <a href="../../index.html" class="btn btn-outline-light btn-sm me-2">
                    <i class="fas fa-home me-1"></i>Về trang chủ
                </a>
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-user-shield me-1"></i>
                        <span id="adminName">Admin</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="../profile.html">
                            <i class="fas fa-user me-2"></i>Profile
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 bg-light py-4 min-vh-100">
                <div class="nav flex-column">
                    <a class="nav-link" href="dashboard.html">
                        <i class="fas fa-chart-line me-2"></i>Dashboard
                    </a>
                    <a class="nav-link" href="products.html">
                        <i class="fas fa-box me-2"></i>Sản phẩm
                    </a>
                    <a class="nav-link active" href="orders.html">
                        <i class="fas fa-shopping-cart me-2"></i>Đơn hàng
                    </a>
                    <a class="nav-link" href="users.html">
                        <i class="fas fa-users me-2"></i>Người dùng
                    </a>
                    <a class="nav-link" href="categories.html">
                        <i class="fas fa-tags me-2"></i>Danh mục
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 py-4">
                <h2 class="fw-bold mb-4">
                    <i class="fas fa-shopping-cart me-2 text-primary"></i>
                    Quản lý đơn hàng
                </h2>

                <!-- Filters -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchOrders"
                                    placeholder="Tìm theo mã đơn, tên khách hàng...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterStatus">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="pending">Chờ xác nhận</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="processing">Đang xử lý</option>
                                    <option value="shipping">Đang giao</option>
                                    <option value="delivered">Đã giao</option>
                                    <option value="cancelled">Đã hủy</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterPayment">
                                    <option value="">Tất cả thanh toán</option>
                                    <option value="pending">Chưa thanh toán</option>
                                    <option value="paid">Đã thanh toán</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="loadOrders()">
                                    <i class="fas fa-filter me-2"></i>Lọc
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Chờ xử lý</p>
                                        <h4 class="fw-bold mb-0" id="pendingCount">0</h4>
                                    </div>
                                    <i class="fas fa-clock fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Đang giao</p>
                                        <h4 class="fw-bold mb-0" id="shippingCount">0</h4>
                                    </div>
                                    <i class="fas fa-truck fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Hoàn thành</p>
                                        <h4 class="fw-bold mb-0" id="deliveredCount">0</h4>
                                    </div>
                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Đã hủy</p>
                                        <h4 class="fw-bold mb-0" id="cancelledCount">0</h4>
                                    </div>
                                    <i class="fas fa-times-circle fa-2x text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 140px;">Mã đơn</th>
                                        <th>Khách hàng</th>
                                        <th>Sản phẩm</th>
                                        <th style="width: 120px;">Ngày đặt</th>
                                        <th style="width: 130px;">Tổng tiền</th>
                                        <th style="width: 120px;">Thanh toán</th>
                                        <th style="width: 150px;">Trạng thái</th>
                                        <th style="width: 100px;">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable">
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="spinner-border text-primary"></div>
                                            <p class="mt-3">Đang tải đơn hàng...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white print-hide">
                    <h5 class="modal-title">
                        <i class="fas fa-file-invoice me-2"></i>
                        Chi tiết đơn hàng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="orderDetailContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-3">Đang tải...</p>
                    </div>
                </div>
                <div class="modal-footer print-hide">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Đóng
                    </button>
                    <button type="button" class="btn btn-success" onclick="printOrder()">
                        <i class="fas fa-print me-2"></i>In đơn hàng
                    </button>
                    <button type="button" class="btn btn-primary" onclick="exportPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Xuất PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/config.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/api.js"></script>

    <script>
        // ================================================
        // CONFIGURATION
        // ================================================
        const API_BASE_URL_LOCAL = 'http://localhost:5000/api';
        let currentPage = 1;
        let allOrders = [];
        let currentOrderData = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!requireAdmin()) return;

            const user = getUser();
            document.getElementById('adminName').textContent = user.fullName || 'Admin';

            await loadOrders();
        });

        // ================================================
        // LOAD ALL ORDERS (ADMIN)
        // ================================================
        async function loadOrders() {
            try {
                const params = {
                    page: currentPage,
                    limit: 20,
                    search: document.getElementById('searchOrders')?.value,
                    status: document.getElementById('filterStatus')?.value,
                    paymentStatus: document.getElementById('filterPayment')?.value
                };

                Object.keys(params).forEach(key => {
                    if (!params[key]) delete params[key];
                });

                const data = await getAllOrders(params);

                if (data.success) {
                    allOrders = data.data;
                    displayOrders(data.data);
                    updateStats(data.data);

                    if (data.pagination) {
                        renderPagination(data.pagination.pages, currentPage, 'pagination');
                    }
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger py-5">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <p>Lỗi tải dữ liệu! Vui lòng thử lại.</p>
                        </td>
                    </tr>
                `;
            }
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTable');

            if (!orders || orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Không có đơn hàng nào</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>
                        <strong class="text-primary">#${order.orderNumber}</strong>
                    </td>
                    <td>
                        <strong>${order.shippingAddress?.fullName || 'N/A'}</strong>
                        <br><small class="text-muted">
                            <i class="fas fa-phone me-1"></i>${order.shippingAddress?.phone || 'N/A'}
                        </small>
                        <br><small class="text-muted">
                            <i class="fas fa-envelope me-1"></i>${order.user?.email || 'N/A'}
                        </small>
                    </td>
                    <td>
                        <span class="text-muted">${order.items?.length || 0} sản phẩm</span>
                    </td>
                    <td>
                        ${new Date(order.createdAt).toLocaleDateString('vi-VN')}
                        <br><small class="text-muted">${new Date(order.createdAt).toLocaleTimeString('vi-VN')}</small>
                    </td>
                    <td>
                        <strong class="text-primary">${formatPrice(order.totalAmount)}</strong>
                    </td>
                    <td>
                        <span class="badge ${getPaymentStatusColor(order.paymentStatus)}">
                            ${getPaymentStatusText(order.paymentStatus)}
                        </span>
                    </td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateStatus('${order._id}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Chờ xác nhận</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Đã xác nhận</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Đang xử lý</option>
                            <option value="shipping" ${order.status === 'shipping' ? 'selected' : ''}>Đang giao</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Đã giao</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Đã hủy</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetail('${order._id}')" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder('${order._id}')" title="Hủy đơn">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(orders) {
            const stats = {
                pending: orders.filter(o => o.status === 'pending' || o.status === 'confirmed' || o.status === 'processing').length,
                shipping: orders.filter(o => o.status === 'shipping').length,
                delivered: orders.filter(o => o.status === 'delivered').length,
                cancelled: orders.filter(o => o.status === 'cancelled').length
            };

            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('shippingCount').textContent = stats.shipping;
            document.getElementById('deliveredCount').textContent = stats.delivered;
            document.getElementById('cancelledCount').textContent = stats.cancelled;
        }

        async function updateStatus(orderId, newStatus) {
            try {
                showLoading();
                const data = await updateOrderStatus(orderId, newStatus, 'Admin cập nhật trạng thái');
                hideLoading();

                if (data.success) {
                    showToast('Cập nhật trạng thái thành công!');
                    await loadOrders();
                } else {
                    showToast(data.message, 'error');
                    await loadOrders();
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                showToast('Có lỗi xảy ra!', 'error');
                await loadOrders();
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('Bạn có chắc muốn hủy đơn hàng này?')) return;
            await updateStatus(orderId, 'cancelled');
        }

        // ================================================
        // VIEW ORDER DETAIL - ADMIN API
        // ================================================
        async function viewOrderDetail(orderId) {
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();

            const content = document.getElementById('orderDetailContent');
            content.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3">Đang tải chi tiết đơn hàng...</p>
                </div>
            `;

            try {
                // ========================================
                // GỌI API ADMIN ĐỂ XEM CHI TIẾT ĐƠN HÀNG
                // ========================================
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/orders/admin/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                console.log('Order Detail Response:', data);

                if (data.success) {
                    currentOrderData = data.data;
                    renderInvoice(data.data);
                } else {
                    content.innerHTML = `
                        <div class="alert alert-danger m-4">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            ${data.message || 'Không thể tải chi tiết đơn hàng!'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Có lỗi xảy ra khi tải chi tiết đơn hàng!
                        <br><small class="text-muted">Error: ${error.message}</small>
                    </div>
                `;
            }
        }

        // ================================================
        // RENDER INVOICE
        // ================================================
        function renderInvoice(order) {
            const content = document.getElementById('orderDetailContent');
            
            // Tính toán các giá trị
            const subtotal = order.subtotal || order.items.reduce((sum, item) => sum + (item.subtotal || item.price * item.quantity), 0);
            const shippingFee = order.shippingFee || 0;
            const discount = order.discount || 0;
            const totalAmount = order.totalAmount || (subtotal + shippingFee - discount);
            
            content.innerHTML = `
                <div class="invoice-container" id="invoiceContent">
                    <!-- Invoice Header -->
                    <div class="invoice-header">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <div class="invoice-logo">
                                    <i class="fas fa-shopping-bag me-2"></i>FASHION SHOP
                                </div>
                                <p class="text-muted mb-0 mt-2">
                                    <i class="fas fa-map-marker-alt me-1"></i> 123 Đường ABC, Quận 1, TP.HCM<br>
                                    <i class="fas fa-phone me-1"></i> 0123 456 789<br>
                                    <i class="fas fa-envelope me-1"></i> support@fashionshop.com
                                </p>
                            </div>
                            <div class="col-6 text-end">
                                <h2 class="invoice-title mb-2">HÓA ĐƠN</h2>
                                <p class="mb-1"><strong>Mã đơn:</strong> #${order.orderNumber}</p>
                                <p class="mb-1"><strong>Ngày đặt:</strong> ${new Date(order.createdAt).toLocaleDateString('vi-VN')}</p>
                                <p class="mb-0">
                                    <span class="badge ${getStatusColor(order.status)} status-badge">
                                        ${getStatusText(order.status)}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Customer & Shipping Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="invoice-info-box h-100">
                                <h6 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-user me-2"></i>THÔNG TIN KHÁCH HÀNG
                                </h6>
                                <p class="mb-1"><strong>Họ tên:</strong> ${order.shippingAddress?.fullName || 'N/A'}</p>
                                <p class="mb-1"><strong>Email:</strong> ${order.user?.email || 'N/A'}</p>
                                <p class="mb-0"><strong>Điện thoại:</strong> ${order.shippingAddress?.phone || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="invoice-info-box h-100">
                                <h6 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-shipping-fast me-2"></i>ĐỊA CHỈ GIAO HÀNG
                                </h6>
                                <p class="mb-1"><strong>Địa chỉ:</strong> ${order.shippingAddress?.street || 'N/A'}</p>
                                <p class="mb-1"><strong>Quận/Huyện:</strong> ${order.shippingAddress?.district || 'N/A'}</p>
                                <p class="mb-1"><strong>Thành phố:</strong> ${order.shippingAddress?.city || 'N/A'}</p>
                                ${order.shippingAddress?.note ? `<p class="mb-0"><strong>Ghi chú:</strong> ${order.shippingAddress.note}</p>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Payment Info -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="invoice-info-box">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6 class="fw-bold text-primary mb-2">
                                            <i class="fas fa-credit-card me-2"></i>THANH TOÁN
                                        </h6>
                                        <p class="mb-0">${getPaymentMethodText(order.paymentMethod)}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="fw-bold text-primary mb-2">
                                            <i class="fas fa-money-bill me-2"></i>TRẠNG THÁI
                                        </h6>
                                        <span class="badge ${getPaymentStatusColor(order.paymentStatus)}">
                                            ${getPaymentStatusText(order.paymentStatus)}
                                        </span>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="fw-bold text-primary mb-2">
                                            <i class="fas fa-calendar me-2"></i>NGÀY ĐẶT
                                        </h6>
                                        <p class="mb-0">${new Date(order.createdAt).toLocaleString('vi-VN')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="fas fa-box me-2"></i>CHI TIẾT SẢN PHẨM
                    </h6>
                    <table class="table invoice-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Sản phẩm</th>
                                <th style="width: 100px;" class="text-center">Size/Màu</th>
                                <th style="width: 80px;" class="text-center">SL</th>
                                <th style="width: 130px;" class="text-end">Đơn giá</th>
                                <th style="width: 130px;" class="text-end">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>
                                        <strong>${item.name}</strong>
                                        ${item.product?.brand ? `<br><small class="text-muted">${item.product.brand}</small>` : ''}
                                    </td>
                                    <td class="text-center">
                                        ${item.size || '-'} / ${item.color || '-'}
                                    </td>
                                    <td class="text-center">${item.quantity}</td>
                                    <td class="text-end">${formatPrice(item.price)}</td>
                                    <td class="text-end"><strong>${formatPrice(item.subtotal || item.price * item.quantity)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="invoice-total-row">
                                <td colspan="5" class="text-end">Tạm tính:</td>
                                <td class="text-end"><strong>${formatPrice(subtotal)}</strong></td>
                            </tr>
                            <tr class="invoice-total-row">
                                <td colspan="5" class="text-end">Phí vận chuyển:</td>
                                <td class="text-end"><strong>${formatPrice(shippingFee)}</strong></td>
                            </tr>
                            ${discount > 0 ? `
                                <tr class="invoice-total-row">
                                    <td colspan="5" class="text-end">Giảm giá:</td>
                                    <td class="text-end text-success"><strong>-${formatPrice(discount)}</strong></td>
                                </tr>
                            ` : ''}
                            <tr class="invoice-grand-total">
                                <td colspan="5" class="text-end">TỔNG CỘNG:</td>
                                <td class="text-end"><strong>${formatPrice(totalAmount)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Order Timeline -->
                    ${order.statusHistory && order.statusHistory.length > 0 ? `
                        <h6 class="fw-bold text-primary mb-3 mt-4">
                            <i class="fas fa-history me-2"></i>LỊCH SỬ ĐƠN HÀNG
                        </h6>
                        <div class="invoice-info-box">
                            ${order.statusHistory.map(history => `
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge ${getStatusColor(history.status)} me-2">${getStatusText(history.status)}</span>
                                    <small class="text-muted">${new Date(history.updatedAt || history.changedAt).toLocaleString('vi-VN')}</small>
                                    ${history.note ? `<small class="ms-2">- ${history.note}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Invoice Footer -->
                    <div class="invoice-footer">
                        <p class="mb-1"><strong>Cảm ơn quý khách đã mua hàng tại Fashion Shop!</strong></p>
                        <p class="mb-0 text-muted small">
                            Mọi thắc mắc xin liên hệ: 0123 456 789 | support@fashionshop.com
                        </p>
                    </div>
                </div>
            `;
        }

        // ================================================
        // PRINT ORDER
        // ================================================
        function printOrder() {
            const printContent = document.getElementById('invoiceContent');
            if (!printContent || !currentOrderData) {
                showToast('Không có nội dung để in!', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>In đơn hàng #${currentOrderData.orderNumber}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <style>
                        body { padding: 20px; font-family: 'Segoe UI', Tahoma, sans-serif; }
                        .invoice-container { max-width: 800px; margin: 0 auto; }
                        .invoice-header { border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 20px; }
                        .invoice-logo { font-size: 24px; font-weight: bold; color: #667eea; }
                        .invoice-title { font-size: 28px; color: #333; text-transform: uppercase; letter-spacing: 2px; }
                        .invoice-info-box { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
                        .invoice-table th { background: #667eea; color: white; padding: 12px; }
                        .invoice-table td { padding: 10px; border-bottom: 1px solid #eee; }
                        .invoice-total-row { background: #f8f9fa; font-weight: bold; }
                        .invoice-grand-total { background: #667eea !important; color: white !important; font-size: 16px; }
                        .invoice-footer { border-top: 2px solid #eee; padding-top: 20px; margin-top: 30px; text-align: center; }
                        .badge { padding: 5px 10px; border-radius: 15px; font-size: 11px; }
                        .bg-warning { background: #ffc107 !important; color: #333 !important; }
                        .bg-success { background: #28a745 !important; color: white !important; }
                        .bg-primary { background: #667eea !important; color: white !important; }
                        .bg-info { background: #17a2b8 !important; color: white !important; }
                        .bg-danger { background: #dc3545 !important; color: white !important; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    ${printContent.innerHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() { window.close(); }
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ================================================
        // EXPORT PDF
        // ================================================
        function exportPDF() {
            const element = document.getElementById('invoiceContent');
            if (!element || !currentOrderData) {
                showToast('Không có nội dung để xuất PDF!', 'error');
                return;
            }

            showToast('Đang tạo file PDF...');

            const opt = {
                margin: 10,
                filename: `DonHang_${currentOrderData.orderNumber}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                showToast('Đã xuất file PDF thành công!');
            }).catch(err => {
                console.error('PDF export error:', err);
                showToast('Lỗi khi xuất PDF!', 'error');
            });
        }

        // ================================================
        // HELPER FUNCTIONS
        // ================================================
        function getStatusColor(status) {
            const colors = {
                pending: 'bg-warning text-dark',
                confirmed: 'bg-info',
                processing: 'bg-primary',
                shipping: 'bg-info',
                delivered: 'bg-success',
                cancelled: 'bg-danger'
            };
            return colors[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const texts = {
                pending: 'Chờ xác nhận',
                confirmed: 'Đã xác nhận',
                processing: 'Đang xử lý',
                shipping: 'Đang giao',
                delivered: 'Đã giao',
                cancelled: 'Đã hủy'
            };
            return texts[status] || status;
        }

        function getPaymentStatusColor(status) {
            return status === 'paid' ? 'bg-success' : 'bg-danger';
        }

        function getPaymentStatusText(status) {
            return status === 'paid' ? 'Đã thanh toán' : 'Chưa thanh toán';
        }

        function getPaymentMethodText(method) {
            const methods = {
                'cod': 'Thanh toán khi nhận hàng (COD)',
                'bank_transfer': 'Chuyển khoản ngân hàng',
                'credit_card': 'Thẻ tín dụng',
                'e_wallet': 'Ví điện tử'
            };
            return methods[method] || method || 'COD';
        }

        function changePage(page) {
            currentPage = page;
            loadOrders();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showLoading() {
            document.body.style.cursor = 'wait';
        }

        function hideLoading() {
            document.body.style.cursor = 'default';
        }
    </script>
</body>

</html>